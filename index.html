<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1" />
<title>kexy</title>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

<style>
  :root{
    --accent:#0095f6;
    --bg:linear-gradient(135deg,#f09433,#e6683c,#dc2743,#cc2366,#bc1888);
  }
  html,body{margin:0;height:100%;font-family:Arial;background:var(--bg);}

  /* PASSWORD SCREEN */
  #passScreen{
    position:fixed;inset:0;background:#000c;display:flex;flex-direction:column;
    align-items:center;justify-content:center;color:#fff;z-index:99999;
  }
  #passScreen input{padding:12px;font-size:20px;border-radius:10px;border:none;text-align:center;width:180px;}
  #passScreen button{margin-top:10px;padding:10px 20px;border:none;border-radius:10px;background:var(--accent);color:white;font-size:18px;}

  /* ROOM CODE SCREEN */
  #roomScreen{position:fixed;inset:0;background:#000c;display:none;flex-direction:column;
    align-items:center;justify-content:center;color:#fff;z-index:9999;}
  #roomScreen input{padding:12px;font-size:20px;border-radius:10px;border:none;text-align:center;width:180px;}
  #roomScreen button{margin-top:10px;padding:10px 20px;border:none;border-radius:10px;background:var(--accent);color:white;font-size:18px;}

  /* MAIN APP */
  .app{display:none;flex-direction:column;height:100vh;padding:8px;box-sizing:border-box;}
  .video-wrap{flex:1;background:#000;border-radius:12px;overflow:hidden;position:relative;}
  video{width:100%;height:100%;object-fit:cover;}

  /* Mirror fix */
  #localVideo{transform:scaleX(-1);}
  #localVideo{
    position:absolute;right:12px;bottom:110px;width:110px;height:150px;
    border-radius:10px;border:2px solid #fff9;background:#000;
  }

  .controls{display:flex;justify-content:center;gap:12px;padding:10px;}
  .controls button{
    width:75px;height:48px;border-radius:999px;border:none;background:#0008;
    font-size:18px;color:white;
  }
  .end{background:#ff3b30 !important;}

  /* CHAT SECTION */
  #chatBox{
    background:#0008;padding:10px;border-radius:10px;height:180px;
    overflow-y:auto;color:white;font-size:16px;display:flex;flex-direction:column;gap:6px;
  }
  #chatInput{width:70%;padding:10px;border:none;border-radius:10px;}
  #sendBtn{padding:10px 20px;border:none;border-radius:10px;background:var(--accent);color:white;}
  #chatArea{display:flex;gap:8px;margin-top:6px;}
</style>
</head>
<body>

<!-- PASSWORD SCREEN -->
<div id="passScreen">
  <h2>Enter App Password</h2>
  <input id="passInput" placeholder="Enter 1008" maxlength="4" inputmode="numeric" />
  <button onclick="checkPass()">Unlock</button>
  <p id="passError" style="color:#f88"></p>
</div>

<!-- ROOM CODE SCREEN -->
<div id="roomScreen">
  <h2>Enter Room Code</h2>
  <input id="roomInput" maxlength="4" inputmode="numeric" placeholder="4-digit code" />
  <button onclick="enterRoom()">Join</button>
  <p id="roomErr" style="color:#f88"></p>
</div>

<!-- MAIN APP -->
<div class="app" id="app">
  
  <div class="video-wrap">
    <video id="remoteVideo" autoplay playsinline></video>
    <video id="localVideo" autoplay muted playsinline></video>
  </div>

  <div class="controls">
    <button id="switchBtn">üîÑ</button>
    <button id="muteBtn">üé§</button>
    <button id="speakerBtn">üîä</button>
    <button id="endBtn" class="end">‚ùå</button>
  </div>

  <div id="chatBox"></div>

  <div id="chatArea">
    <input id="chatInput" placeholder="Message..." />
    <button id="sendBtn">Send</button>
  </div>
</div>

<script>
// Firebase
const firebaseConfig = {
  apiKey: "AIzaSyCdaMeWKKI7P8_sNeVbjs4eRlnufQItlJI",
  authDomain: "video-call-a9749.firebaseapp.com",
  databaseURL: "https://video-call-a9749-default-rtdb.firebaseio.com",
  projectId: "video-call-a9749",
  storageBucket: "video-call-a9749.firebasestorage.app",
  messagingSenderId: "655086083238",
  appId: "1:655086083238:web:ec14414fb08712aa696867"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

// ---------------- PASSWORD ----------------
function checkPass(){
  let p = document.getElementById("passInput").value.trim();
  if(p === "1008"){
    document.getElementById("passScreen").style.display="none";
    document.getElementById("roomScreen").style.display="flex";
  } else {
    document.getElementById("passError").innerText="Wrong Password!";
  }
}

// ------------- ROOM CODE --------------
let ROOM_ID = null;

function enterRoom(){
  ROOM_ID = document.getElementById("roomInput").value.trim();

  if(ROOM_ID.length !== 4){
    document.getElementById("roomErr").innerText="Enter 4-digit code!";
    return;
  }

  document.getElementById("roomScreen").style.display="none";
  document.getElementById("app").style.display="flex";
  startCall();
}

// ---------------- WEBRTC ----------------
let localStream, pc;
const remoteVideo = document.getElementById("remoteVideo");
const localVideo = document.getElementById("localVideo");

async function startCall(){
  localStream = await navigator.mediaDevices.getUserMedia({video:true, audio:true});
  localVideo.srcObject = localStream;

  const ref = db.ref("rooms/"+ROOM_ID);
  const offerSnap = await ref.child("offer").get();

  if(offerSnap.exists()){
    joinCall();
  } else {
    createCall();
  }
}

async function createCall(){
  pc = new RTCPeerConnection();
  localStream.getTracks().forEach(t=>pc.addTrack(t,localStream));

  pc.ontrack = e => remoteVideo.srcObject = e.streams[0];

  pc.onicecandidate = e=>{
    if(e.candidate) db.ref("rooms/"+ROOM_ID+"/candidates").push(JSON.stringify(e.candidate));
  };

  let offer = await pc.createOffer();
  await pc.setLocalDescription(offer);
  db.ref("rooms/"+ROOM_ID+"/offer").set(JSON.stringify(offer));

  db.ref("rooms/"+ROOM_ID+"/answer").on("value", async s=>{
    if(s.val() && !pc.currentRemoteDescription){
      await pc.setRemoteDescription(JSON.parse(s.val()));
    }
  });

  db.ref("rooms/"+ROOM_ID+"/candidates").on("child_added", snap=>{
    pc.addIceCandidate(JSON.parse(snap.val())).catch(()=>{});
  });
}

async function joinCall(){
  pc = new RTCPeerConnection();
  localStream.getTracks().forEach(t=>pc.addTrack(t,localStream));

  pc.ontrack = e => remoteVideo.srcObject = e.streams[0];

  let offer = JSON.parse((await db.ref("rooms/"+ROOM_ID+"/offer").get()).val());
  await pc.setRemoteDescription(offer);

  let answer = await pc.createAnswer();
  await pc.setLocalDescription(answer);
  db.ref("rooms/"+ROOM_ID+"/answer").set(JSON.stringify(answer));

  pc.onicecandidate = e=>{
    if(e.candidate) db.ref("rooms/"+ROOM_ID+"/candidates").push(JSON.stringify(e.candidate));
  };

  db.ref("rooms/"+ROOM_ID+"/candidates").on("child_added", snap=>{
    pc.addIceCandidate(JSON.parse(snap.val())).catch(()=>{});
  });
}

// ---------------- CHAT ----------------
db.ref("chat").on("child_added", snap=>{
  let msg = snap.val();
  let box = document.getElementById("chatBox");
  box.innerHTML += `<div>${msg}</div>`;
  box.scrollTop = box.scrollHeight;
});

document.getElementById("sendBtn").onclick = ()=>{
  let txt = document.getElementById("chatInput").value.trim();
  if(txt === "") return;
  db.ref("chat").push(txt);
  document.getElementById("chatInput").value="";
};

// ---------------- CONTROLS ----------------
document.getElementById("switchBtn").onclick = async ()=>{
  let old = localStream.getVideoTracks()[0];
  old.stop();
  localStream = await navigator.mediaDevices.getUserMedia({video:{facingMode:"environment"}, audio:true});
  localVideo.srcObject = localStream;
};

document.getElementById("muteBtn").onclick = ()=>{
  let mic = localStream.getAudioTracks()[0];
  mic.enabled = !mic.enabled;
};

document.getElementById("speakerBtn").onclick = ()=>{
  remoteVideo.muted = !remoteVideo.muted;
};

document.getElementById("endBtn").onclick = ()=>location.reload();
</script>

</body>
</html>
