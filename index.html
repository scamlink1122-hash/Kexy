<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1" />
<title>Kexy (Firebase + WebRTC)</title>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

<style>
:root{--accent:#0095f6;--bg-gradient:linear-gradient(135deg,#f09433 0%,#e6683c 25%,#dc2743 50%,#cc2366 75%,#bc1888 100%);}
html,body{height:100%;margin:0;font-family:Arial,Helvetica,sans-serif;background:var(--bg-gradient);-webkit-font-smoothing:antialiased;}
#passwordScreen{position:fixed;inset:0;background:rgba(0,0,0,0.85);display:flex;flex-direction:column;align-items:center;justify-content:center;z-index:9999;color:white;}
#passwordScreen h2{margin:0 0 14px;font-size:22px;}
#passwordScreen input{width:140px;padding:12px;font-size:20px;text-align:center;border-radius:10px;border:none;outline:none;}
#passwordScreen button{margin-top:12px;padding:10px 18px;border-radius:10px;border:none;background:var(--accent);color:#fff;font-weight:600}
.app{position:relative;width:100%;height:100vh;display:flex;flex-direction:column;gap:6px;box-sizing:border-box;padding:8px;}
.room-bar{display:flex;gap:8px;align-items:center;background:rgba(255,255,255,0.9);padding:8px;border-radius:10px;}
.room-bar input{flex:1;padding:8px;border-radius:8px;border:1px solid #ddd}
.room-bar button{padding:8px 10px;border-radius:8px;border:none;background:var(--accent);color:#fff;font-weight:600}
.video-wrap{position:relative;flex:1;display:flex;align-items:center;justify-content:center;border-radius:12px;overflow:hidden;background:#000}
video{display:block;object-fit:cover;width:100%;height:100%}
#localVideo{position:absolute;right:12px;bottom:110px;width:110px;height:150px;border-radius:10px;border:2px solid rgba(255,255,255,0.9);background:#000;z-index:30;object-fit:cover;cursor:pointer;transition:all .25s ease;}
#localVideo.minimized{width:80px;height:110px;opacity:0.9}
#remoteVideo.small{width:140px;height:190px;right:12px;bottom:110px;position:absolute;border-radius:10px;border:2px solid rgba(255,255,255,0.9);z-index:20;object-fit:cover}
.controls{display:flex;gap:12px;justify-content:center;align-items:center;padding:8px;}
.controls button{flex:0 0 78px;height:48px;border-radius:999px;border:none;background:rgba(0,0,0,0.6);color:white;font-size:18px;display:flex;align-items:center;justify-content:center;gap:8px;}
.controls button.end{background:#ff3b30}
.chat{background:rgba(255,255,255,0.95);border-radius:12px;padding:8px;display:flex;flex-direction:column;gap:8px;max-height:260px;overflow:hidden;}
.messages{flex:1;overflow-y:auto;display:flex;flex-direction:column;gap:8px;padding:6px}
.msg{max-width:74%;padding:8px;border-radius:12px;background:#f1f1f1;color:#111}
.msg.sent{align-self:flex-end;background:#dcf8c6}
.msg.received{align-self:flex-start;background:#fff;border:1px solid #e2e2e2}
.chat-input{display:flex;gap:8px;align-items:center}
.chat-input input[type="text"]{flex:1;padding:10px;border-radius:10px;border:1px solid #ddd;outline:none}
.chat-input input[type="file"]{display:none}
.file-label{padding:10px 12px;border-radius:10px;background:var(--accent);color:#fff;cursor:pointer}
@media(min-width:900px){.app{max-width:900px;margin:10px auto;height:92vh} #localVideo{right:18px;bottom:120px}}
</style>
</head>
<body>

<div id="passwordScreen">
<h2>Enter 4-Digit Password</h2>
<input id="passInput" maxlength="4" placeholder="****" inputmode="numeric" />
<button id="passBtn">Unlock</button>
<p id="passError" style="color:#ff8888;margin-top:10px"></p>
</div>

<div class="app" id="app" style="display:none">
<div class="room-bar">
<input id="roomLink" readonly placeholder="Room link will generate when unlocked">
<button id="copyBtn">Copy</button>
</div>
<div class="video-wrap" id="videoWrap">
<video id="remoteVideo" autoplay playsinline></video>
<video id="localVideo" autoplay muted playsinline></video>
</div>
<div class="controls">
<button id="switchBtn">üîÑ</button>
<button id="muteBtn">üé§</button>
<button id="speakerBtn">üîä</button>
<button id="endBtn" class="end">‚ùå</button>
</div>
<div class="chat">
<div class="messages" id="messages"></div>
<div class="chat-input">
<input type="text" id="textInput" placeholder="Type a message..." />
<label class="file-label" title="Send image/video">üìé<input type="file" id="fileInput" accept="image/*,video/*"></label>
<button id="sendBtn" style="padding:10px 12px;background:var(--accent);color:#fff;border:none;border-radius:8px">Send</button>
</div>
</div>
</div>

<script>
const firebaseConfig = {
apiKey:"AIzaSyCdaMeWKKI7P8_sNeVbjs4eRlnufQItlJI",
authDomain:"video-call-a9749.firebaseapp.com",
databaseURL:"https://video-call-a9749-default-rtdb.firebaseio.com",
projectId:"video-call-a9749",
storageBucket:"video-call-a9749.appspot.com",
messagingSenderId:"655086083238",
appId:"1:655086083238:web:ec14414fb08712aa696867",
measurementId:"G-4KR499NMHS"
};
firebase.initializeApp(firebaseConfig);
const db=firebase.database();

/* Elements */
const passScreen=document.getElementById('passwordScreen');
const passInput=document.getElementById('passInput');
const passBtn=document.getElementById('passBtn');
const passError=document.getElementById('passError');
const appDiv=document.getElementById('app');
const roomLinkInput=document.getElementById('roomLink');
const copyBtn=document.getElementById('copyBtn');
const remoteVideo=document.getElementById('remoteVideo');
const localVideo=document.getElementById('localVideo');
const switchBtn=document.getElementById('switchBtn');
const muteBtn=document.getElementById('muteBtn');
const speakerBtn=document.getElementById('speakerBtn');
const endBtn=document.getElementById('endBtn');
const messagesDiv=document.getElementById('messages');
const textInput=document.getElementById('textInput');
const fileInput=document.getElementById('fileInput');
const sendBtn=document.getElementById('sendBtn');

/* State */
let localStream, pc, roomId, dataChannel, muted=false, speakerOn=true, facingMode='user';
const HOST_PASSWORD="1008";

/* Password */
passBtn.addEventListener('click',tryUnlock);
passInput.addEventListener('keydown',e=>{if(e.key==='Enter')tryUnlock();});
function tryUnlock(){
const v=passInput.value.trim();
if(v===HOST_PASSWORD){
passScreen.style.display='none';
appDiv.style.display='flex';
initApp();
}else{passError.textContent='Wrong password'; setTimeout(()=>passError.textContent='',2000);}
}

/* Messages */
function addMessage(text,type='received',fileType){
const el=document.createElement('div'); el.className='msg '+(type==='sent'?'sent':'received');
if(fileType){ if(fileType.startsWith('image')){ const img=document.createElement('img'); img.src=text; img.style.maxWidth='220px'; img.style.borderRadius='8px'; el.appendChild(img);}
else if(fileType.startsWith('video')){ const v=document.createElement('video'); v.src=text; v.controls=true; v.style.maxWidth='220px'; v.style.borderRadius='8px'; el.appendChild(v);}
else el.textContent='[file]';}
else el.textContent=text;
messagesDiv.appendChild(el); messagesDiv.scrollTop=messagesDiv.scrollHeight;
}

/* Local Media */
async function startLocalStream(){
try{ const constraints={audio:true,video:{width:{ideal:1280},height:{ideal:720},facingMode}};
localStream=await navigator.mediaDevices.getUserMedia(constraints); localVideo.srcObject=localStream;
}catch(err){alert('Camera/Microphone access required: '+err.message);}
}

/* WebRTC + Firebase */
async function initApp(){
await startLocalStream();
roomId=new URLSearchParams(location.search).get('room'); 
if(!roomId){ roomId=Math.random().toString(36).substring(2,10); roomLinkInput.value=`${location.origin}${location.pathname}?room=${roomId}`;}
else{roomLinkInput.value=`${location.origin}${location.pathname}?room=${roomId}`;}

const servers={iceServers:[{urls:'stun:stun.l.google.com:19302'}]};
pc=new RTCPeerConnection(servers);

localStream.getTracks().forEach(track=>pc.addTrack(track,localStream));
pc.ontrack=e=>remoteVideo.srcObject=e.streams[0];

dataChannel=pc.createDataChannel('chat'); dataChannel.onmessage=e=>addMessage(e.data,'received');
pc.ondatachannel=e=>{ e.channel.onmessage=ev=>addMessage(ev.data,'received'); }

const roomRef=db.ref('rooms/'+roomId+'/signals');

if(!new URLSearchParams(location.search).get('join')){
const offer=await pc.createOffer(); await pc.setLocalDescription(offer);
roomRef.push({type:'offer',sdp:offer.sdp});}

roomRef.on('child_added', async snapshot=>{
const data=snapshot.val(); if(!data) return;
if(data.type==='offer' && !pc.currentRemoteDescription){ await pc.setRemoteDescription({type:'offer',sdp:data.sdp}); const answer=await pc.createAnswer(); await pc.setLocalDescription(answer); roomRef.push({type:'answer',sdp:answer.sdp});}
else if(data.type==='answer' && !pc.currentRemoteDescription){ await pc.setRemoteDescription({type:'answer',sdp:data.sdp});}
else if(data.type==='ice' && data.candidate){ try{ await pc.addIceCandidate(data.candidate); }catch(e){}}
});

pc.onicecandidate=e=>{ if(e.candidate) roomRef.push({type:'ice',candidate:e.candidate.toJSON()});}
}

/* Send messages */
sendBtn.addEventListener('click',sendMessage);
textInput.addEventListener('keydown',e=>{if(e.key==='Enter')sendMessage();});
function sendMessage(){
const txt=textInput.value.trim(); const file=fileInput.files[0];
if(txt){ addMessage(txt,'sent'); if(dataChannel) dataChannel.send(txt); textInput.value='';}
if(file){ const MAX=8*1024*1024; if(file.size>MAX){alert('File too large'); return;}
const reader=new FileReader(); reader.onload=()=>{ const dataUrl=reader.result; addMessage(dataUrl,'sent',file.type); if(dataChannel)dataChannel.send(dataUrl);}
reader.readAsDataURL(file); fileInput.value='';}
}

/* Controls */
switchBtn.addEventListener('click',async()=>{
facingMode=(facingMode==='user')?'environment':'user';
if(localStream) localStream.getTracks().forEach(t=>t.stop());
await startLocalStream();
const sender=pc.getSenders().find(s=>s.track && s.track.kind==='video');
if(sender) sender.replaceTrack(localStream.getVideoTracks()[0]);
});

muteBtn.addEventListener('click',()=>{muted=!muted; if(localStream)localStream.getAudioTracks().forEach(t=>t.enabled=!muted); muteBtn.textContent=muted?'üîá':'üé§';});
speakerBtn.addEventListener('click',()=>{speakerOn=!speakerOn; remoteVideo.muted=!speakerOn; speakerBtn.textContent=speakerOn?'üîä':'üîà';});
endBtn.addEventListener('click',()=>location.reload());
localVideo.addEventListener('click',()=>{localVideo.classList.toggle('minimized'); remoteVideo.classList.toggle('small');});
remoteVideo.addEventListener('click',()=>{remoteVideo.classList.toggle('small'); localVideo.classList.toggle('minimized');});
copyBtn.addEventListener('click',()=>{navigator.clipboard.writeText(roomLinkInput.value).then(()=>{copyBtn.textContent='Copied'; setTimeout(()=>copyBtn.textContent='Copy',1200);});});
</script>
</body>
  </html>
