<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Kexy ‚Äî Insta-like WebRTC</title>

<!-- Firebase SDKs -->
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-storage-compat.js"></script>

<style>
  :root{
    --accent:#0095f6;
    --bg: linear-gradient(135deg,#f09433,#e6683c,#dc2743,#cc2366,#bc1888);
  }
  html,body{height:100%;margin:0;font-family:Arial,Helvetica,sans-serif;background:var(--bg);-webkit-font-smoothing:antialiased;}
  /* password overlay */
  .overlay{
    position:fixed;inset:0;display:flex;align-items:center;justify-content:center;z-index:99999;color:#fff;
    background:rgba(0,0,0,0.8);flex-direction:column;gap:12px;padding:20px;box-sizing:border-box;
  }
  .card{background:rgba(255,255,255,0.02);padding:18px;border-radius:12px;box-shadow:0 6px 18px rgba(0,0,0,0.35);min-width:260px;text-align:center}
  input[type="text"], input[type="password"], input[type="number"]{padding:12px;border-radius:10px;border:none;width:100%;box-sizing:border-box;text-align:center;font-size:16px}
  button.btn{padding:10px 14px;border-radius:10px;border:none;background:var(--accent);color:#fff;font-weight:700;cursor:pointer}
  button.ghost{background:transparent;border:1px solid rgba(255,255,255,0.12);color:#fff}

  /* app */
  .app{display:none;flex-direction:column;height:100vh;padding:10px;box-sizing:border-box;gap:8px}
  .topbar{display:flex;gap:8px;align-items:center;background:rgba(255,255,255,0.9);padding:8px;border-radius:10px}
  .topbar input{flex:1;padding:8px;border-radius:8px;border:1px solid #ddd}
  .video-wrap{position:relative;flex:1;border-radius:12px;overflow:hidden;background:#000;display:flex;align-items:center;justify-content:center}
  video{display:block;object-fit:cover;width:100%;height:100%}
  /* mirror local */
  #localVideo{position:absolute;right:14px;bottom:110px;width:120px;height:160px;border-radius:12px;border:2px solid rgba(255,255,255,0.9);background:#000;z-index:40;cursor:pointer;transform:scaleX(-1)}
  #localVideo.minimized{width:88px;height:120px;right:12px;bottom:90px;opacity:0.95}
  #remoteVideo.small{width:160px;height:210px;right:14px;bottom:110px;position:absolute;border-radius:12px;border:2px solid rgba(255,255,255,0.9);z-index:30;object-fit:cover}

  .controls{display:flex;gap:10px;justify-content:center;padding:8px}
  .controls button{flex:0 0 78px;height:48px;border-radius:999px;border:none;background:rgba(0,0,0,0.6);color:white;font-size:18px;display:flex;align-items:center;justify-content:center}
  .controls button.end{background:#ff3b30}
  /* chat placed under buttons */
  .chat{
    background:rgba(255,255,255,0.95);border-radius:12px;padding:8px;display:flex;flex-direction:column;gap:8px;max-height:260px;overflow:hidden;
  }
  .messages{flex:1;overflow-y:auto;display:flex;flex-direction:column;gap:8px;padding:6px}
  .msg{max-width:74%;padding:8px;border-radius:12px;background:#f1f1f1;color:#111}
  .msg.me{align-self:flex-end;background:#dcf8c6}
  .msg .meta{font-size:12px;color:#666;margin-bottom:6px}
  .chat-input{display:flex;gap:8px;align-items:center}
  .chat-input input[type="text"]{flex:1;padding:10px;border-radius:10px;border:1px solid #ddd;outline:none}
  .file-label{padding:10px 12px;border-radius:10px;background:var(--accent);color:#fff;cursor:pointer}
  .file-thumb{max-width:220px;border-radius:8px;display:block}

  @media(min-width:900px){ .app{max-width:980px;margin:12px auto;height:94vh} #localVideo{right:20px;bottom:140px} }
</style>
</head>
<body>

<!-- PASSWORD (1008) -->
<div id="passOverlay" class="overlay">
  <div class="card">
    <h2 style="margin:0 0 10px">Enter App Password</h2>
    <input id="appPass" type="password" maxlength="4" placeholder="Enter 4-digit password" />
    <div style="height:10px"></div>
    <button id="unlockBtn" class="btn">Unlock</button>
    <p id="passMsg" style="color:#ff9b9b;margin-top:8px"></p>
  </div>
</div>

<!-- HOST/GUEST create/join (appears after unlock) -->
<div id="roomOverlay" class="overlay" style="display:none">
  <div class="card">
    <h3 style="margin:0 0 8px">Create Room (Host) or Join (Guest)</h3>
    <input id="roomCodeInput" maxlength="4" placeholder="4-digit room code (e.g. 4829)" />
    <div style="display:flex;gap:8px;margin-top:10px">
      <button id="createRoomBtn" class="btn">Create Room (Host)</button>
      <button id="joinRoomBtn" class="ghost">Join Room (Guest)</button>
    </div>
    <p id="roomMsg" style="color:#ffd7d7;margin-top:8px;font-size:13px">Host creates room & shares the 4-digit code with guest.</p>
  </div>
</div>

<!-- APP -->
<div class="app" id="app" style="display:none">

  <div class="topbar room-bar">
    <input id="roomLink" readonly placeholder="Room link will show after creating room" />
    <button id="copyBtn">Copy</button>
  </div>

  <div class="video-wrap" id="videoWrap">
    <video id="remoteVideo" autoplay playsinline></video>
    <video id="localVideo" autoplay muted playsinline></video>
  </div>

  <div class="controls">
    <button id="switchBtn">üîÑ</button>
    <button id="shareBtn">üì∫</button>
    <button id="muteBtn">üé§</button>
    <button id="speakerBtn">üîä</button>
    <button id="endBtn" class="end">‚ùå</button>
  </div>

  <div class="chat">
    <div class="messages" id="messages"></div>
    <div class="chat-input">
      <input type="text" id="textInput" placeholder="Type a message..." />
      <label class="file-label" title="Send image/video">üìé
        <input type="file" id="fileInput" accept="image/*,video/*" style="display:none">
      </label>
      <button id="sendBtn" style="padding:10px 12px;background:var(--accent);color:#fff;border:none;border-radius:8px">Send</button>
    </div>
  </div>
</div>

<script>
/* ================= Firebase demo config =================
   Replace with your Firebase project's config in production.
*/
const firebaseConfig = {
  apiKey: "AIzaSyCdaMeWKKI7P8_sNeVbjs4eRlnufQItlJI",
  authDomain: "video-call-a9749.firebaseapp.com",
  databaseURL: "https://video-call-a9749-default-rtdb.firebaseio.com",
  projectId: "video-call-a9749",
  storageBucket: "video-call-a9749.firebasestorage.app",
  messagingSenderId: "655086083238",
  appId: "1:655086083238:web:ec14414fb08712aa696867",
  measurementId: "G-4KR499NMHS"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();
const storage = firebase.storage();

/* ================= UI refs ================= */
const passOverlay = document.getElementById('passOverlay');
const appPass = document.getElementById('appPass');
const unlockBtn = document.getElementById('unlockBtn');
const passMsg = document.getElementById('passMsg');

const roomOverlay = document.getElementById('roomOverlay');
const roomCodeInput = document.getElementById('roomCodeInput');
const createRoomBtn = document.getElementById('createRoomBtn');
const joinRoomBtn = document.getElementById('joinRoomBtn');
const roomMsg = document.getElementById('roomMsg');

const appDiv = document.getElementById('app');
const roomLink = document.getElementById('roomLink');
const copyBtn = document.getElementById('copyBtn');

const remoteVideo = document.getElementById('remoteVideo');
const localVideo = document.getElementById('localVideo');
const switchBtn = document.getElementById('switchBtn');
const shareBtn = document.getElementById('shareBtn');
const muteBtn = document.getElementById('muteBtn');
const speakerBtn = document.getElementById('speakerBtn');
const endBtn = document.getElementById('endBtn');

const messagesDiv = document.getElementById('messages');
const textInput = document.getElementById('textInput');
const fileInput = document.getElementById('fileInput');
const sendBtn = document.getElementById('sendBtn');

/* ================= state ================= */
const APP_PASSWORD = "1008";
let ROOM = null;
let role = null; // 'host' or 'guest'
let pc = null;
let localStream = null;
let isSharing = false;
let screenTrack = null;

/* ================= ICE servers (STUN + Free TURN fallback) =================
  Note: For production, get a TURN server you control (coturn or paid provider).
  The included TURN is a public/free relay which may be rate-limited.
*/
const ICE_SERVERS = [
  { urls: "stun:stun1.l.google.com:19302" },
  { urls: "stun:stun2.l.google.com:19302" },
  // free-ish relay (may be rate-limited) - helps many NAT cases
  { urls: "turn:openrelay.metered.ca:443?transport=tcp", username: "openrelayproject", credential: "openrelayproject" }
];

/* ================= Helpers ================= */
function show(el){ el.style.display = 'flex'; }
function hide(el){ el.style.display = 'none'; }
function log(msg){ console.log('[Kexy]', msg); }

/* ================= Password gate ================= */
unlockBtn.addEventListener('click', tryUnlock);
appPass.addEventListener('keydown', e=>{ if(e.key==='Enter') tryUnlock(); });

function tryUnlock(){
  const v = (appPass.value || '').trim();
  if(v === APP_PASSWORD){
    hide(passOverlay);
    show(roomOverlay);
    // focus code input
    roomCodeInput.focus();
  } else {
    passMsg.innerText = 'Wrong password';
    setTimeout(()=> passMsg.innerText = '',2000);
  }
}

/* ================= Create / Join UI ================= */
createRoomBtn.addEventListener('click', async ()=>{
  const code = (roomCodeInput.value || '').trim();
  if(!/^\d{4}$/.test(code)){ roomMsg.innerText = 'Enter a 4-digit code.'; setTimeout(()=>roomMsg.innerText='',2000); return; }
  ROOM = code;
  role = 'host';
  // write meta (so guest can optionally verify)
  await db.ref('rooms/'+ROOM+'/meta').set({host:true,created:Date.now()});
  hide(roomOverlay);
  startAppUI();
  await startLocalCamera();
  await createCall(ROOM);
  setupChat(ROOM);
  // show the permanent link to copy/share
  roomLink.value = location.href.split('?')[0] + '?room=' + ROOM;
});

joinRoomBtn.addEventListener('click', ()=>{
  const code = (roomCodeInput.value || '').trim();
  if(!/^\d{4}$/.test(code)){ roomMsg.innerText = 'Enter a 4-digit code.'; setTimeout(()=>roomMsg.innerText='',2000); return; }
  ROOM = code;
  role = 'guest';
  hide(roomOverlay);
  startAppUI();
  // guest will start camera and attempt join
  (async ()=>{ await startLocalCamera(); await joinCall(ROOM); setupChat(ROOM); })();
});

/* ================= App UI show ================= */
function startAppUI(){
  hide(passOverlay);
  hide(roomOverlay);
  show(appDiv);
  messagesDiv.innerHTML = '';
}

/* ================= Start camera ================= */
async function startLocalCamera(){
  try{
    localStream = await navigator.mediaDevices.getUserMedia({video:{facingMode:'user'}, audio:true});
    localVideo.srcObject = localStream;
  } catch(err){
    alert('Camera/Microphone access required: ' + err.message);
    console.error(err);
  }
}

/* ================= PeerConnection setup ================= */
function createPeerConnection(roomId){
  pc = new RTCPeerConnection({ iceServers: ICE_SERVERS });

  // add local tracks
  if(localStream){
    localStream.getTracks().forEach(t => pc.addTrack(t, localStream));
  }

  // remote stream
  pc.ontrack = e => {
    if(e.streams && e.streams[0]) remoteVideo.srcObject = e.streams[0];
    else {
      const ms = new MediaStream();
      if(e.track) ms.addTrack(e.track);
      remoteVideo.srcObject = ms;
    }
  };

  // ICE -> DB (role-specific)
  pc.onicecandidate = e => {
    if(!e.candidate) return;
    const json = JSON.stringify(e.candidate);
    if(role === 'host') db.ref('rooms/'+roomId+'/hostCandidates').push(json);
    else db.ref('rooms/'+roomId+'/guestCandidates').push(json);
  };

  pc.onconnectionstatechange = ()=> log('pc state: '+pc.connectionState);
  return pc;
}

/* ================= Host: create offer ================= */
async function createCall(roomId){
  createPeerConnection(roomId);
  const offer = await pc.createOffer();
  await pc.setLocalDescription(offer);
  await db.ref('rooms/'+roomId+'/offer').set(JSON.stringify(offer));

  // listen for answer
  db.ref('rooms/'+roomId+'/answer').on('value', async snap=>{
    const val = snap.val();
    if(val && !pc.currentRemoteDescription){
      await pc.setRemoteDescription(JSON.parse(val));
    }
  });

  // incorporate guest ICE
  db.ref('rooms/'+roomId+'/guestCandidates').on('child_added', snap=>{
    const c = snap.val();
    try{ pc.addIceCandidate(JSON.parse(c)).catch(()=>{}); } catch(e){}
  });
}

/* ================= Guest: join offer and send answer ================= */
async function joinCall(roomId){
  createPeerConnection(roomId);

  // read offer
  const offerSnap = await db.ref('rooms/'+roomId+'/offer').get();
  const offerVal = offerSnap.val();
  if(!offerVal){
    alert('Host has not started the room yet. Ask host to create room.');
    return;
  }
  await pc.setRemoteDescription(JSON.parse(offerVal));

  const answer = await pc.createAnswer();
  await pc.setLocalDescription(answer);
  await db.ref('rooms/'+roomId+'/answer').set(JSON.stringify(answer));

  // listen for host ICE
  db.ref('rooms/'+roomId+'/hostCandidates').on('child_added', snap=>{
    const c = snap.val();
    try{ pc.addIceCandidate(JSON.parse(c)).catch(()=>{}); } catch(e){}
  });
}

/* ================= Chat (per room) ================= */
function setupChat(roomId){
  messagesDiv.innerHTML = '';
  const chatRef = db.ref('rooms/'+roomId+'/chat');
  chatRef.off();
  chatRef.on('child_added', snap=>{
    const m = snap.val();
    if(!m) return;
    appendMessage(m);
  });
}

function appendMessage(m){
  const el = document.createElement('div');
  el.className = 'msg ' + (m.sender === (role==='host' ? 'host' : 'guest') ? 'me' : '');
  const meta = `<div class="meta">${m.sender} ‚Ä¢ ${new Date(m.ts||Date.now()).toLocaleTimeString()}</div>`;
  if(m.type === 'text'){
    el.innerHTML = meta + `<div>${escapeHtml(m.text)}</div>`;
  } else if(m.type === 'file'){
    if(m.mimetype && m.mimetype.startsWith('image')){
      el.innerHTML = meta + `<a href="${m.url}" target="_blank"><img src="${m.url}" class="file-thumb" /></a>`;
    } else if(m.mimetype && m.mimetype.startsWith('video')){
      el.innerHTML = meta + `<a href="${m.url}" target="_blank"><video class="file-thumb" controls src="${m.url}"></video></a>`;
    } else {
      el.innerHTML = meta + `<a href="${m.url}" target="_blank">${escapeHtml(m.name||'file')}</a>`;
    }
  }
  messagesDiv.appendChild(el);
  messagesDiv.scrollTop = messagesDiv.scrollHeight;
}

/* ================= Send message & file ================= */
sendBtn.addEventListener('click', sendMessage);
textInput.addEventListener('keydown', e=>{ if(e.key==='Enter') sendMessage(); });

async function sendMessage(){
  const txt = (textInput.value||'').trim();
  const file = fileInput.files[0];
  const chatRef = db.ref('rooms/'+ROOM+'/chat');

  if(txt){
    chatRef.push({ sender: role==='host'?'host':'guest', type:'text', text:txt, ts:Date.now() });
    textInput.value = '';
  }
  if(file){
    const MAX = 25 * 1024 * 1024;
    if(file.size > MAX){ alert('File too large (max 25MB)'); return; }
    const path = 'chatFiles/'+ROOM+'/'+Date.now()+'_'+file.name;
    const ref = storage.ref(path);
    const up = ref.put(file);
    // optional temporary message
    const tmp = document.createElement('div'); tmp.className='msg me'; tmp.textContent='Uploading...'; messagesDiv.appendChild(tmp); messagesDiv.scrollTop = messagesDiv.scrollHeight;
    up.on('state_changed', ()=>{}, err=>{ alert('Upload error:'+err.message); tmp.remove(); }, async ()=>{
      const url = await ref.getDownloadURL();
      await chatRef.push({ sender: role==='host'?'host':'guest', type:'file', url, name:file.name, mimetype:file.type, ts:Date.now() });
      tmp.remove();
    });
    fileInput.value = '';
  }
}

/* ================= Controls: switch, mute, speaker, end ================= */
switchBtn.addEventListener('click', async ()=>{
  try{
    if(!localStream) return;
    const cur = localStream.getVideoTracks()[0];
    if(cur) cur.stop();
    // try environment then fallback
    try{
      localStream = await navigator.mediaDevices.getUserMedia({ video:{facingMode:'environment'}, audio:true });
    } catch(e){
      localStream = await navigator.mediaDevices.getUserMedia({ video:{facingMode:'user'}, audio:true });
    }
    localVideo.srcObject = localStream;
    // replace track in pc if exists
    const sender = pc && pc.getSenders().find(s=>s.track && s.track.kind === 'video');
    const camTrack = localStream.getVideoTracks()[0];
    if(sender && camTrack) await sender.replaceTrack(camTrack);
  } catch(err){ console.error(err); }
});

muteBtn.addEventListener('click', ()=>{
  if(!localStream) return;
  const a = localStream.getAudioTracks()[0];
  if(a) { a.enabled = !a.enabled; muteBtn.textContent = a.enabled ? 'üé§' : 'üîá'; }
});

speakerBtn.addEventListener('click', ()=>{
  remoteVideo.muted = !remoteVideo.muted;
  speakerBtn.textContent = remoteVideo.muted ? 'üîà' : 'üîä';
});

endBtn.addEventListener('click', ()=>{
  try{ pc && pc.close(); } catch(e){}
  location.reload();
});

/* ================= Screen share ================= */
shareBtn.addEventListener('click', async ()=>{
  if(!pc){ alert('Connection not ready'); return; }
  if(!isSharing){
    try{
      const screenStream = await navigator.mediaDevices.getDisplayMedia({video:true});
      screenTrack = screenStream.getVideoTracks()[0];
      const sender = pc.getSenders().find(s=>s.track && s.track.kind === 'video');
      if(sender) await sender.replaceTrack(screenTrack);
      else pc.addTrack(screenTrack, screenStream);
      isSharing = true;
      shareBtn.textContent = 'üõë Stop';
      screenTrack.onended = () => stopShare();
    } catch(err){ console.error(err); alert('Screen share failed: '+err.message); }
  } else stopShare();
});

async function stopShare(){
  const sender = pc && pc.getSenders().find(s=>s.track && s.track.kind === 'video');
  const camTrack = localStream && localStream.getVideoTracks()[0];
  if(sender && camTrack) await sender.replaceTrack(camTrack);
  try{ screenTrack && screenTrack.stop(); }catch(e){}
  isSharing = false;
  shareBtn.textContent = 'üì∫';
}

/* ================= Copy link ================= */
copyBtn.addEventListener('click', ()=>{
  if(roomLink.value) navigator.clipboard.writeText(roomLink.value).then(()=>{ copyBtn.textContent='Copied'; setTimeout(()=>copyBtn.textContent='Copy',1200); });
});

/* ================= Escape helper ================= */
function escapeHtml(s){ if(!s) return ''; return String(s).replace(/[&<>"'`=\/]/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;','/':'&#x2F;','`':'&#x60;','=':'&#x3D;'}[c])); }

/* ================= Clean up on unload ================= */
window.addEventListener('beforeunload', ()=>{ try{ pc && pc.close(); }catch(e){} });

</script>
</body>
  </html>
