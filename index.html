<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1" />
<title>kexy</title>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

<style>
  :root{
    --accent:#0095f6;
    --bg-gradient: linear-gradient(135deg,#f09433 0%,#e6683c 25%,#dc2743 50%,#cc2366 75%,#bc1888 100%);
  }
  html,body{height:100%;margin:0;font-family:Arial,Helvetica,sans-serif;background:var(--bg-gradient);}

  /* NUMBER SCREEN */
  #numberScreen{
    position:fixed;inset:0;background:rgba(0,0,0,0.85);
    display:flex;flex-direction:column;align-items:center;justify-content:center;
    z-index:9999;color:white;
  }
  #numberScreen h2{margin:0 0 14px;font-size:22px;}
  #numberScreen input{
    width:180px;padding:12px;font-size:20px;text-align:center;
    border-radius:10px;border:none;outline:none;
  }
  #numberScreen button{
    margin-top:12px;padding:10px 18px;border-radius:10px;
    border:none;background:var(--accent);color:#fff;font-weight:600
  }

  /* MAIN APP */
  .app {position:relative;width:100%;height:100vh;display:none;flex-direction:column;gap:6px;padding:8px;box-sizing:border-box;}
  .video-wrap{position:relative;flex:1;display:flex;align-items:center;justify-content:center;border-radius:12px;overflow:hidden;background:#000}
  video{display:block;object-fit:cover;width:100%;height:100%}
  #localVideo{
    position:absolute;right:12px;bottom:110px;width:110px;height:150px;
    border-radius:10px;border:2px solid rgba(255,255,255,0.9);background:#000;
  }

  .controls{
    display:flex;gap:12px;justify-content:center;padding:8px;
  }
  .controls button{
    flex:0 0 78px;height:48px;border-radius:999px;border:none;
    background:rgba(0,0,0,0.6);color:white;font-size:18px;
  }
  .controls button.end{background:#ff3b30}
</style>
</head>
<body>

<!-- NUMBER INPUT SCREEN -->
<div id="numberScreen">
  <h2>Enter Your Mobile Number</h2>
  <input id="numberInput" maxlength="10" inputmode="numeric" placeholder="10-digit number" />
  <button id="numberBtn">Continue</button>
  <p id="numError" style="color:#ff8888;margin-top:10px"></p>
</div>

<!-- APP -->
<div class="app" id="app">
  <div class="video-wrap">
    <video id="remoteVideo" autoplay playsinline></video>
    <video id="localVideo" autoplay muted playsinline></video>
  </div>

  <div class="controls">
    <button id="switchBtn">üîÑ</button>
    <button id="muteBtn">üé§</button>
    <button id="speakerBtn">üîä</button>
    <button id="endBtn" class="end">‚ùå</button>
  </div>
</div>

<script>
// ----------- Firebase Config -----------
const firebaseConfig = {
  apiKey: "AIzaSyCdaMeWKKI7P8_sNeVbjs4eRlnufQItlJI",
  authDomain: "video-call-a9749.firebaseapp.com",
  databaseURL: "https://video-call-a9749-default-rtdb.firebaseio.com",
  projectId: "video-call-a9749",
  storageBucket: "video-call-a9749.firebasestorage.app",
  messagingSenderId: "655086083238",
  appId: "1:655086083238:web:ec14414fb08712aa696867",
  measurementId: "G-4KR499NMHS"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();


// ----------- Number Check -----------
const ALLOWED_NUMBER = "9575669078";
const numberScreen = document.getElementById("numberScreen");
const numberInput = document.getElementById("numberInput");
const numberBtn = document.getElementById("numberBtn");
const numError = document.getElementById("numError");
const appDiv = document.getElementById("app");

numberBtn.onclick = () => checkNumber();

function checkNumber(){
  const num = numberInput.value.trim();
  if(num === ALLOWED_NUMBER){
    numberScreen.style.display="none";
    appDiv.style.display="flex";
    initCall();
  } else {
    numError.textContent = "Invalid Number!";
    setTimeout(()=> numError.textContent="",2000);
  }
}


// ----------- WebRTC -----------
let localStream, pc;
const remoteVideo = document.getElementById("remoteVideo");
const localVideo = document.getElementById("localVideo");

// FIXED ROOM ID
const ROOM_ID = "kexyroom";

async function initCall(){
  await startCamera();
  checkRoom(ROOM_ID);
}

async function startCamera(){
  localStream = await navigator.mediaDevices.getUserMedia({video:true, audio:true});
  localVideo.srcObject = localStream;
}

async function checkRoom(id){
  const offerSnap = await db.ref("rooms/"+id+"/offer").get();

  if(offerSnap.exists()){
    joinCall(id);
  } else {
    createCall(id);
  }
}

async function createCall(id){
  pc = new RTCPeerConnection();
  localStream.getTracks().forEach(t=>pc.addTrack(t, localStream));

  pc.ontrack = e => remoteVideo.srcObject = e.streams[0];
  pc.onicecandidate = e => { if(e.candidate) db.ref("rooms/"+id+"/candidates").push(JSON.stringify(e.candidate)); };

  const offer = await pc.createOffer();
  await pc.setLocalDescription(offer);
  db.ref("rooms/"+id+"/offer").set(JSON.stringify(offer));

  db.ref("rooms/"+id+"/answer").on("value", async snap=>{
    if(snap.val() && !pc.currentRemoteDescription){
      await pc.setRemoteDescription(JSON.parse(snap.val()));
    }
  });

  db.ref("rooms/"+id+"/candidates").on("child_added", snap=>{
    const c = JSON.parse(snap.val());
    pc.addIceCandidate(c).catch(()=>{});
  });
}

async function joinCall(id){
  pc = new RTCPeerConnection();
  localStream.getTracks().forEach(t=>pc.addTrack(t, localStream));

  pc.ontrack = e => remoteVideo.srcObject = e.streams[0];
  const offer = JSON.parse((await db.ref("rooms/"+id+"/offer").get()).val());
  await pc.setRemoteDescription(offer);

  const answer = await pc.createAnswer();
  await pc.setLocalDescription(answer);
  db.ref("rooms/"+id+"/answer").set(JSON.stringify(answer));

  pc.onicecandidate = e => { if(e.candidate) db.ref("rooms/"+id+"/candidates").push(JSON.stringify(e.candidate)); };

  db.ref("rooms/"+id+"/candidates").on("child_added", snap=>{
    const c = JSON.parse(snap.val());
    pc.addIceCandidate(c).catch(()=>{});
  });
}


// -------- Controls --------
document.getElementById("switchBtn").onclick = async ()=>{
  let track = localStream.getVideoTracks()[0];
  await track.stop();
  localStream = await navigator.mediaDevices.getUserMedia({
    video:{facingMode:"environment"}, audio:true
  });
  localVideo.srcObject = localStream;
};

document.getElementById("muteBtn").onclick = ()=>{
  localStream.getAudioTracks()[0].enabled = !localStream.getAudioTracks()[0].enabled;
};

document.getElementById("speakerBtn").onclick = ()=>{
  remoteVideo.muted = !remoteVideo.muted;
};

document.getElementById("endBtn").onclick = ()=>{
  location.reload();
};

</script>
</body>
</html>
