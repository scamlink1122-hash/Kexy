<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1" />
<title>Kexy Secure</title>

<!-- Firebase SDKs -->
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

<style>
  :root{--accent:#0095f6;--bg:linear-gradient(135deg,#f09433,#cc2366);}
  html,body{height:100%;margin:0;font-family:Arial,Helvetica,sans-serif;background:var(--bg);-webkit-font-smoothing:antialiased;color:#111}
  .brand{position:absolute;left:12px;top:10px;color:#fff;font-weight:700}
  /* Password overlay */
  #passwordScreen{position:fixed;inset:0;background:rgba(0,0,0,0.85);display:none;align-items:center;justify-content:center;z-index:9999;color:white;flex-direction:column}
  #passwordScreen h2{margin:0 0 14px;font-size:20px}
  #passwordScreen input{width:140px;padding:12px;font-size:20px;text-align:center;border-radius:10px;border:none;outline:none}
  #passwordScreen button{margin-top:12px;padding:10px 18px;border-radius:10px;border:none;background:var(--accent);color:#fff;font-weight:600}

  /* App UI */
  .app{display:none;height:100vh;box-sizing:border-box;padding:8px;display:flex;flex-direction:column;gap:8px}
  .room-bar{display:flex;gap:8px;align-items:center;background:rgba(255,255,255,0.95);padding:8px;border-radius:10px}
  .room-bar input{flex:1;padding:8px;border-radius:8px;border:1px solid #ddd}
  .video-wrap{flex:1;position:relative;border-radius:12px;overflow:hidden;background:#000;display:flex;align-items:center;justify-content:center}
  video{width:100%;height:100%;object-fit:cover;display:block}
  #localVideo{position:absolute;right:12px;bottom:110px;width:110px;height:150px;border-radius:10px;border:2px solid rgba(255,255,255,.9);z-index:30;object-fit:cover;cursor:pointer}
  .controls{display:flex;gap:12px;justify-content:center;padding:8px}
  .controls button{padding:10px 14px;border-radius:999px;border:none;background:rgba(0,0,0,0.6);color:#fff;font-size:18px}
  .chat{background:rgba(255,255,255,0.95);border-radius:12px;padding:8px;display:flex;flex-direction:column;gap:8px;max-height:260px;overflow:hidden}
  .messages{flex:1;overflow:auto;display:flex;flex-direction:column;gap:8px;padding:6px}
  .msg{max-width:74%;padding:8px;border-radius:12px;background:#f1f1f1;color:#111}
  .msg.sent{align-self:flex-end;background:#dcf8c6}
  .msg.received{align-self:flex-start;background:#fff;border:1px solid #e2e2e2}
  .chat-input{display:flex;gap:8px;align-items:center}
  .chat-input input[type="text"]{flex:1;padding:10px;border-radius:10px;border:1px solid #ddd;outline:none}
</style>
</head>
<body>

<div class="brand">Kexy Secure</div>

<!-- Password Overlay -->
<div id="passwordScreen">
  <h2>Enter 4-digit password (ddmm)</h2>
  <input id="passInput" maxlength="4" placeholder="****" inputmode="numeric" />
  <button id="passBtn">Unlock</button>
  <p id="passError" style="color:#ff8888;margin-top:10px"></p>
</div>

<!-- Main App UI -->
<div class="app" id="app">
  <div class="room-bar">
    <input id="roomLink" readonly placeholder="Room link will generate">
    <button id="copyBtn">Copy</button>
  </div>
  <div class="video-wrap" id="videoWrap">
    <video id="remoteVideo" autoplay playsinline></video>
    <video id="localVideo" autoplay muted playsinline></video>
  </div>
  <div class="controls">
    <button id="switchBtn">üîÑ</button>
    <button id="muteBtn">üé§</button>
    <button id="speakerBtn">üîä</button>
    <button id="endBtn">‚ùå</button>
  </div>
  <div class="chat">
    <div class="messages" id="messages"></div>
    <div class="chat-input">
      <input type="text" id="textInput" placeholder="Type a message..." />
      <label style="padding:10px 12px;border-radius:10px;background:var(--accent);color:#fff;cursor:pointer">
        üìé
        <input type="file" id="fileInput" accept="image/*,video/*" style="display:none">
      </label>
      <button id="sendBtn" style="padding:10px 12px;background:var(--accent);color:#fff;border:none;border-radius:8px">Send</button>
    </div>
  </div>
</div>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyCdaMeWKKI7P8_sNeVbjs4eRlnufQItlJI",
  authDomain: "video-call-a9749.firebaseapp.com",
  databaseURL: "https://video-call-a9749-default-rtdb.firebaseio.com",
  projectId: "video-call-a9749",
  storageBucket: "video-call-a9749.firebasestorage.app",
  messagingSenderId: "655086083238",
  appId: "1:655086083238:web:ec14414fb08712aa696867",
  measurementId: "G-4KR499NMHS"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

const passwordScreen = document.getElementById('passwordScreen');
const passInput = document.getElementById('passInput');
const passBtn = document.getElementById('passBtn');
const passError = document.getElementById('passError');
const appDiv = document.getElementById('app');

function getTodayPassword(){
  const d = new Date();
  const day = String(d.getDate()).padStart(2,'0');
  const month = String(d.getMonth()+1).padStart(2,'0');
  return day + month;
}

function showPassword(){ passwordScreen.style.display='flex'; appDiv.style.display='none'; }
function showAppUI(){ passwordScreen.style.display='none'; appDiv.style.display='flex'; }

/* Firebase listener for appStatus */
const statusRef = db.ref('appStatus');
statusRef.on('value', snap=>{
  const s = snap.val();
  if(s==='on'){
    showPassword();
  } else {
    // App off -> redirect to Flipkart
    window.location.href = 'https://www.flipkart.com';
  }
});

/* Password handling */
passBtn.addEventListener('click', tryUnlock);
passInput.addEventListener('keydown', e=>{ if(e.key==='Enter') tryUnlock(); });

function tryUnlock(){
  const v = passInput.value.trim();
  if(v === getTodayPassword()){
    passError.textContent='';
    initializeApp();
    showAppUI();
  } else {
    passError.textContent='Wrong password';
    setTimeout(()=>passError.textContent='',2000);
  }
}

/* WebRTC + Chat setup (same as before) */
let localStream=null, pc=null, roomId=null, facingMode='user', muted=false, speakerOn=true;
const remoteVideo=document.getElementById('remoteVideo');
const localVideo=document.getElementById('localVideo');
const switchBtn=document.getElementById('switchBtn');
const muteBtn=document.getElementById('muteBtn');
const speakerBtn=document.getElementById('speakerBtn');
const endBtn=document.getElementById('endBtn');
const messagesDiv=document.getElementById('messages');
const textInput=document.getElementById('textInput');
const fileInput=document.getElementById('fileInput');
const sendBtn=document.getElementById('sendBtn');

async function startLocalStream(){
  try{
    const constraints={video:{facingMode},audio:true};
    const stream=await navigator.mediaDevices.getUserMedia(constraints);
    if(localStream && pc){
      const oldVideoTrack=localStream.getVideoTracks()[0];
      const newVideoTrack=stream.getVideoTracks()[0];
      const sender=pc.getSenders().find(s=>s.track && s.track.kind==='video');
      if(sender) await sender.replaceTrack(newVideoTrack);
      if(oldVideoTrack){ localStream.removeTrack(oldVideoTrack); oldVideoTrack.stop(); }
      localStream.addTrack(newVideoTrack);
      localVideo.srcObject=null; localVideo.srcObject=localStream;
    } else { localStream=stream; localVideo.srcObject=localStream; }
  }catch(e){ alert('Camera/Mic access required: '+e.message); console.error(e); }
}

async function initializeApp(){
  await startLocalStream();
  createRoom();
  setupChat();
}

async function createRoom(){
  pc=new RTCPeerConnection();
  localStream.getTracks().forEach(track=>pc.addTrack(track,localStream));
  pc.ontrack=e=>{ remoteVideo.srcObject=e.streams[0]; };
  pc.onicecandidate=e=>{ if(e.candidate) db.ref('rooms/'+roomId+'/candidates').push(JSON.stringify(e.candidate)); };
  roomId=Math.random().toString(36).substring(2,10);
  const offer=await pc.createOffer(); await pc.setLocalDescription(offer);
  db.ref('rooms/'+roomId+'/offer').set(JSON.stringify(offer));
  db.ref('rooms/'+roomId+'/answer').on('value', async snap=>{ const answer=snap.val(); if(answer && !pc.currentRemoteDescription) await pc.setRemoteDescription(JSON.parse(answer)); });
  db.ref('rooms/'+roomId+'/candidates').on('child_added', snap=>{ const c=JSON.parse(snap.val()); if(c) pc.addIceCandidate(c).catch(()=>{}); });
}

/* Chat setup */
function setupChat(){
  const chatRef=db.ref('rooms/'+roomId+'/chat');
  chatRef.on('child_added', snap=>{ const msg=snap.val(); addMessage(msg.text,'received',msg.fileType); });
  sendBtn.onclick=sendMessage;
  textInput.addEventListener('keydown', e=>{ if(e.key==='Enter') sendMessage(); });
}
function addMessage(text,type='received',fileType){
  const el=document.createElement('div'); el.className='msg '+(type==='sent'?'sent':'received');
  if(fileType){
    if(fileType.startsWith('image')){ const img=document.createElement('img'); img.src=text; img.style.maxWidth='220px'; img.style.borderRadius='8px'; el.appendChild(img); }
    else if(fileType.startsWith('video')){ const v=document.createElement('video'); v.src=text; v.controls=true; v.style.maxWidth='220px'; v.style.borderRadius='8px'; el.appendChild(v); }
    else el.textContent='[file]';
  } else el.textContent=text;
  messagesDiv.appendChild(el); messagesDiv.scrollTop=messagesDiv.scrollHeight;
}
function sendMessage(){
  const txt=textInput.value.trim(); const file=fileInput.files[0]; const chatRef=db.ref('rooms/'+roomId+'/chat');
  if(txt){ chatRef.push({text:txt}); addMessage(txt,'sent'); textInput.value=''; }
  if(file){
    const MAX=8*1024*1024; if(file.size>MAX){ alert('File too large'); return; }
    const reader=new FileReader();
    reader.onload=()=>{ chatRef.push({text:reader.result,fileType:file.type}); addMessage(reader.result,'sent',file.type); }
    reader.readAsDataURL(file); fileInput.value='';
  }
}

/* Controls */
switchBtn.addEventListener('click', async()=>{ facingMode=(facingMode==='user')?'environment':'user'; await startLocalStream(); });
muteBtn.addEventListener('click', ()=>{ muted=!muted; if(localStream) localStream.getAudioTracks().forEach(t=>t.enabled=!muted); muteBtn.textContent=muted?'üîá':'üé§'; });
speakerBtn.addEventListener('click', ()=>{ speakerOn=!speakerOn; remoteVideo.muted=!speakerOn; speakerBtn.textContent=speakerOn?'üîä':'üîà'; });
endBtn.addEventListener('click', ()=>{ location.reload(); });
localVideo.addEventListener('click', ()=>{ localVideo.classList.toggle('minimized'); remoteVideo.classList.toggle('small'); });
</script>
</body>
</html>
