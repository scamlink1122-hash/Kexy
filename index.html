<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Kexy</title>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

<style>
body{margin:0;font-family:Arial,sans-serif;background:#111;color:#fff;}
#adminBox, #loginBox, #mainApp{display:flex;flex-direction:column;align-items:center;justify-content:center;height:100vh;}
button{padding:10px 16px;margin:8px;border:none;border-radius:8px;background:#0095f6;color:#fff;font-weight:600;cursor:pointer;}
input{padding:10px 12px;border-radius:8px;border:none;margin:6px;font-size:16px;}
#mainApp{display:none;width:100%;height:100vh;flex-direction:column;}
.video-wrap{position:relative;flex:1;display:flex;justify-content:center;align-items:center;background:#000;}
video{width:100%;height:100%;object-fit:cover;}
#localVideo{position:absolute;width:120px;height:160px;bottom:12px;right:12px;border:2px solid #fff;border-radius:8px;cursor:pointer;}
.controls{display:flex;gap:12px;justify-content:center;margin:8px;}
.controls button{flex:0 0 60px;height:40px;border-radius:50%;background:rgba(0,0,0,0.5);}
.chat{background:rgba(255,255,255,0.9);color:#000;max-height:200px;overflow-y:auto;padding:6px;}
.msg{padding:6px;margin:4px;border-radius:8px;}
.msg.sent{background:#dcf8c6;align-self:flex-end;}
.msg.received{background:#fff;align-self:flex-start;}
</style>
</head>
<body>

<!-- ADMIN -->
<div id="adminBox">
<h2>Admin Panel</h2>
<button onclick="generatePassword()">Generate 4-Digit Password</button>
<p id="genPass" style="color:#0f0;"></p>
</div>

<!-- USER LOGIN -->
<div id="loginBox">
<h2>Enter Password to Join</h2>
<input id="userPass" type="text" placeholder="****" maxlength="4">
<button onclick="checkPassword()">Submit</button>
<p id="passError" style="color:#f88;"></p>
</div>

<!-- MAIN APP -->
<div id="mainApp">
<div class="video-wrap">
<video id="remoteVideo" autoplay playsinline></video>
<video id="localVideo" autoplay muted playsinline></video>
</div>
<div class="controls">
<button id="switchBtn">üîÑ</button>
<button id="muteBtn">üé§</button>
<button id="speakerBtn">üîä</button>
<button id="endBtn">‚ùå</button>
</div>
<div class="chat" id="messages"></div>
<input type="text" id="textInput" placeholder="Type message...">
<button id="sendBtn">Send</button>
</div>

<script>
/* ---------------- Firebase ---------------- */
const firebaseConfig = {
apiKey:"AIzaSyCdaMeWKKI7P8_sNeVbjs4eRlnufQItlJI",
authDomain:"video-call-a9749.firebaseapp.com",
databaseURL:"https://video-call-a9749-default-rtdb.firebaseio.com",
projectId:"video-call-a9749",
storageBucket:"video-call-a9749.appspot.com",
messagingSenderId:"655086083238",
appId:"1:655086083238:web:ec14414fb08712aa696867",
measurementId:"G-4KR499NMHS"
};
firebase.initializeApp(firebaseConfig);
const db=firebase.database();
const passRef = db.ref("system/password");

/* ---------------- Admin Generate ---------------- */
function generatePassword(){
let pass = Math.floor(1000+Math.random()*9000).toString();
passRef.set(pass).then(()=>{document.getElementById("genPass").innerText="Password Generated: "+pass;});
}

/* ---------------- User Check ---------------- */
function checkPassword(){
let entered = document.getElementById("userPass").value;
passRef.once("value").then(snap=>{
if(snap.val() === entered){
document.getElementById("loginBox").style.display="none";
document.getElementById("mainApp").style.display="flex";
initCall();
}else{document.getElementById("passError").innerText="Wrong Password!"; setTimeout(()=>{document.getElementById("passError").innerText="";},2000); }
});
}

/* ---------------- WebRTC Call ---------------- */
let localStream, pc, muted=false, speakerOn=true, facingMode='user';

async function initCall(){
localStream = await navigator.mediaDevices.getUserMedia({video:{facingMode},audio:true});
document.getElementById("localVideo").srcObject=localStream;

const servers={iceServers:[{urls:'stun:stun.l.google.com:19302'}]};
pc = new RTCPeerConnection(servers);
localStream.getTracks().forEach(t=>pc.addTrack(t,localStream));

const remoteVideo=document.getElementById("remoteVideo");
pc.ontrack=e=>remoteVideo.srcObject=e.streams[0];

/* Chat DataChannel */
let dataChannel = pc.createDataChannel("chat");
dataChannel.onmessage=e=>addMessage(e.data,"received");
pc.ondatachannel=e=>{e.channel.onmessage=ev=>addMessage(ev.data,"received");}

/* Firebase signaling */
let roomId="room1"; // fixed room, or generate random
let roomRef=db.ref("rooms/"+roomId+"/signals");

pc.onicecandidate=e=>{ if(e.candidate) roomRef.push({type:'ice',candidate:e.candidate.toJSON()});}

roomRef.on('child_added',async snap=>{
const data=snap.val();
if(!data) return;
if(data.type==='offer' && !pc.currentRemoteDescription){ await pc.setRemoteDescription({type:'offer',sdp:data.sdp}); const answer=await pc.createAnswer(); await pc.setLocalDescription(answer); roomRef.push({type:'answer',sdp:answer.sdp});}
else if(data.type==='answer' && !pc.currentRemoteDescription){ await pc.setRemoteDescription({type:'answer',sdp:data.sdp});}
else if(data.type==='ice' && data.candidate){ try{ await pc.addIceCandidate(data.candidate);}catch(e){} }
});

/* Offer */
const offer = await pc.createOffer();
await pc.setLocalDescription(offer);
roomRef.push({type:'offer',sdp:offer.sdp});
}

/* ---------------- Chat ---------------- */
function addMessage(text,type='received'){const el=document.createElement('div'); el.className='msg '+(type==='sent'?'sent':'received'); el.innerText=text; document.getElementById('messages').appendChild(el);}

document.getElementById("sendBtn").addEventListener('click',()=>{
let txt=document.getElementById("textInput").value.trim();
if(txt){ addMessage(txt,"sent"); document.getElementById("textInput").value=""; /* send via dataChannel */ }
});

/* ---------------- Controls ---------------- */
document.getElementById("switchBtn").addEventListener('click',async()=>{
facingMode=(facingMode==='user')?'environment':'user';
if(localStream) localStream.getTracks().forEach(t=>t.stop());
localStream = await navigator.mediaDevices.getUserMedia({video:{facingMode},audio:true});
document.getElementById("localVideo").srcObject=localStream;
const sender=pc.getSenders().find(s=>s.track && s.track.kind==='video');
if(sender) sender.replaceTrack(localStream.getVideoTracks()[0]);
});

document.getElementById("muteBtn").addEventListener('click',()=>{muted=!muted; localStream.getAudioTracks().forEach(t=>t.enabled=!muted); document.getElementById("muteBtn").textContent=muted?'üîá':'üé§';});
document.getElementById("speakerBtn").addEventListener('click',()=>{speakerOn=!speakerOn; document.getElementById("remoteVideo").muted=!speakerOn; document.getElementById("speakerBtn").textContent=speakerOn?'üîä':'üîà';});
document.getElementById("endBtn").addEventListener('click',()=>location.reload());
</script>

</body>
</html>
